name: immortalwrt

on:
  workflow_dispatch:
    inputs:
      ssh:
        description: "Enable SSH debug"
        required: false
        default: "false"

env:
  TZ: Asia/Shanghai    
  
jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Free disk space
      uses: coder-xiaomo/free-disk-space@main
      with:
        tool-cache: false
        android: true
        dotnet: true
        haskell: true
        large-packages: true
        docker-images: true
        swap-storage: true        

    - name: Install Build Dependencies
      run: |
        sudo -E apt-get -qq update
        sudo -E apt-get -qq install build-essential clang flex bison g++ gawk \
        gcc-multilib g++-multilib gettext git libncurses5-dev libssl-dev \
        python3-setuptools rsync swig unzip zlib1g-dev file wget \
        llvm python3-pyelftools libpython3-dev aria2 jq qemu-utils ccache rename \
        libelf-dev device-tree-compiler libgmp3-dev libmpc-dev libfuse-dev
        sudo -E apt-get -qq autoremove --purge
        sudo -E apt-get -qq clean
        sudo timedatectl set-timezone "Asia/Shanghai"

    - name: Clone ImmortalWrt
      run: |
        git clone --depth 1 https://github.com/immortalwrt/immortalwrt.git immortalwrt

    - name: Configure Feeds
      working-directory: immortalwrt
      run: |
        sed -i '$a src-git smpackage https://github.com/kenzok8/small-package' feeds.conf.default

    - name: Update feeds
      working-directory: immortalwrt
      run: |
        ./scripts/feeds update -a

    - name: Defconfig Feeds
      working-directory: immortalwrt
      run: |
        rm -rf feeds/packages/lang/golang
        git clone https://github.com/kenzok8/golang -b 1.25 feeds/packages/lang/golang
        rm -rf feeds/packages/net/{alist,adguardhome,brook,gost,mosdns,redsocks*,smartdns,trojan*,v2ray*,xray*}
        rm -rf feeds/packages/luci/{luci-app-homeproxy,luci-app-openclash,luci-app-passwall}
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: Apply Config
      working-directory: immortalwrt
      run: |
        cp ../immortalwrt.config .config
        make defconfig

    - name: Download Packages
      working-directory: immortalwrt
      run: |
        make download -j8

    - name: Cache
      uses: klever1988/cachewrtbuild@main
      with:
        ccache: 'true'
        prefix: ${{ github.workspace }}/immortalwrt

    - name: Build Firmware
      working-directory: immortalwrt
      run: |
        make -j$(nproc) || make -j1 V=s

    - name: SSH Debug
      if: github.event.inputs.ssh == 'true'
      uses: mxschmitt/action-tmate@v3

    - name: Upload Firmware
      uses: actions/upload-artifact@v4
      with:
        name: immortalwrt-x86-firmware
        path: immortalwrt/bin/targets/x86/64/
